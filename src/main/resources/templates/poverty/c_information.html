<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/bootstrap-clearmin.min.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/roboto.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/material-design.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/small-n-flat.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/assets/css/font-awesome.min.css}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="container-fiuled">
    <div class="panel panel-default">
        <div class="panel-heading">申请先建后补项目</div>
        <div class="panel-body" style="min-height: 264px;">
            <form class="form-horizontal">
                <div class="form-group" >
                    <label  class="col-sm-2 control-label">申请项目类型：</label>
                    <div class="col-sm-10">
                        <select  class="form-control col-sm-10" name="option" id="select">
                            <option value="-1">请选择项目</option>
                            <option th:each="project : ${projects}" th:value="${project.id}" th:text="${project.projectName }">
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="outlay" class="col-sm-2 control-label">项目申请经费：</label>
                    <div class="col-sm-10">
                        <input type="text" name="outlay" class="form-control" id="outlay" placeholder="请输入项目申请经费/元..." required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="startTime" class="col-sm-2 control-label">建设开始时间：</label>
                    <div class="col-sm-10">
                        <input type="date" name="startTime" class="form-control" id="startTime" placeholder="请输入建设开始时间..." required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="endTime" class="col-sm-2 control-label">建设结束时间：</label>
                    <div class="col-sm-10">
                        <input   type="date" name="endTime" class="form-control" id="endTime" placeholder="请输入建设结束时间..." required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="downloadTemplate" class="col-sm-2 control-label">项目申请书模板下载：</label><br>
                    <div class="col-sm-10">
                        <button class="btn btn-info form-control" type="button" id="downloadTemplate">模板下载</button>
                    </div>
                </div>
                <div class="form-group" >
                    <label for="identify_project" class="col-sm-2 control-label">项目申请书：</label><br>
                    <div class="col-sm-10">
                        <div class="file-container" style="display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                            <button class="btn btn-success fileinput-button form-control" type="button">项目申请书上传</button>
                            <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="identify_project" id="identify_project" onchange="saveFile(this)">
                        </div>&nbsp;
                        <span id="projectFileName" style="vertical-align: middle">未上传文件</span>
                    </div>
                </div>
                <div class="form-group" >
                    <label for="identify_other" class="col-sm-2 control-label">其他证明材料：</label><br>
                    <div class="col-sm-10">
                        <div class="file-container" style="display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                            <button class="btn btn-success fileinput-button form-control" type="button" id="other">其他证明材料上传</button>
                            <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="identify_other" id="identify_other" onchange="saveFile(this)">
                        </div>&nbsp;
                        <span id="otherFileName">未上传文件</span>
                    </div>
                </div>
                <br />
                <br /><br />
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="button" id="sub" class="btn btn-warning" style="width: 100%;">提交申请</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script th:src="@{/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/lib/jquery-2.1.3.min.js}"></script>
<script th:src="@{/assets/js/jquery.mousewheel.min.js}"></script>
<script th:src="@{/assets/js/jquery.cookie.min.js}"></script>
<script th:src="@{/assets/js/fastclick.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/clearmin.min.js}"></script>
<script th:src="@{/assets/js/demo/home.js}"></script>
<script th:inline="javascript">
    //记录已上传文件的信息
    var applicationPath = null;
    var applicationName = null;
    var otherPath = null;
    var otherName = null;

    //保存文件
    function saveFile(obj){
        var data = new FormData();
        if(obj.id=='identify_project'){
        //上传的是申请书
            data.append('path',applicationPath);
            applicationName = obj.files[0].name;
            $("#projectFileName").text(applicationName);
        }else{
            data.append('path',otherPath);
            otherName = obj.files[0].name;
            $("#otherFileName").text(otherName);
        }
        data.append('file', obj.files[0]);
        var filename = obj.value;
        var extStart = filename.lastIndexOf('.');
        var ext = obj.value.substring(extStart,filename.length);
        data.append('type',ext);
        $.ajax({
        url: '/admin/upload',
        type: 'POST',
        data: data,
        cache: false,
        processData: false,
        contentType: false,
        success:function(result){
                alert("上传成功！");
                if(obj.id=='identify_project'){
                    //上传的是申请书
                    applicationPath = result;
                }else{
                    otherPath = result;
                }
            },
        error:function(result){
                alert("上传失败！");
            }
        });
    }

    //封装验证

    //保存申请书
    $('#sub').click(function(){
        if($("#select").val() == -1){
            alert("请选择申请的项目！")
        }else{
            $.post('/poverty/saveInformation',
            {
                "projectId":$('#select').val(),
                "outlay":$("#outlay").val(),
                "startTime":$("#startTime").val(),
                "endTime":$("#endTime").val(),
                "otherProof":otherPath,
                "otherProofName":otherName,
                "projectApplication":applicationPath,
                "projectApplicationName":applicationName
            },function(status){
                if(status == "success"){
                    alert("保存成功！")
                    window.location.href="/poverty/manage"
                }else{
                    alert("网络错误！请稍后再试");
                }
            });
        }
    });

    //下载模板
    $('#downloadTemplate').click(function(){
        if($("#select").val() == -1){
            alert("请选择申请的项目！")
        }else
        {
            window.location.href="/poverty/downloadTemplate?id="+$("#select").val()
        }
    });
</script>
</body>
</html>