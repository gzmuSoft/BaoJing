<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>
    <!-- Bootstrap -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="col-sm-12">
        <h3>扶贫先建后补</h3>
        <!--分割线-->
        <div class="decoration"></div>
        <div class="full-width">
            <h4 class="shadow">补充你的基本信息</h4>
            <p class="shadow">在提交申请表之前，请检查你的信息是否完整，不可有错误信息！</p>
        </div>
        <!--分割线-->
        <div class="decoration"></div>
        <!--表单-->
        <div class="form">
            <form class="form-horizontal">
                <div class="form-group">
                    <label for="name" class="col-sm-2 control-label">姓名：</label>
                    <div class="col-sm-10">
                        <input  type="text" name="name" class="form-control" id="name" onblur='onName(this)' placeholder="姓名" required>
                        <div id="tishiName" style="color: red;"></div>
                    </div>

                </div>
                <div class="form-group">
                    <label for="identity" class="col-sm-2 control-label">身份证号码：</label>
                    <div class="col-sm-10">
                        <input  type="text" name="identity" class="form-control" id="identity" placeholder="身份证号码" onblur='onIdentity(this)' required>
                        <div id="tishiIdentity" style="color: red;"></div>
                    </div>
                    <script>
                        function onName(){
                            console.log($("#name"))
                            if($("#name").val() == null || $("#name").val() ==""){
                                $("#tishiName").html("*请填写名字")
                            }else{
                                $("#tishiName").html("")
                            }
                        }
                        function onIdentity(){

                            if($("#identity").val().length<18 || $("#identity").val().length>18){
                                $("#tishiIdentity").html("*身份证号码填写有误")
                            }else{
                                $("#tishiIdentity").html("")
                            }
                        }
                        function onOneCardSolution(){
                            if($("#oneCardSolution").val().length<22 || $("#oneCardSolution").val().length>22){
                                $("#tishiOneCardSolution").html("*一卡通号码填写有误")
                            }else{
                                $("#tishiOneCardSolution").html("")
                            }
                        }
                        function onTel(){
                            if($("#tel").val() == null || $("#tel").val() ==""){
                                $("#tishiTel").html("*请填写电话")
                            }else{
                                $("#tishiTel").html("")
                            }
                        }
                        function onVillage(){
                            if($("#village").val() == null || $("#village").val() ==""){
                                $("#tishiVillage").html("*请填写村组")
                            }else{
                                $("#tishiVillage").html("")
                            }
                        }
                    </script>
                </div>
                <div class="form-group">
                    <label for="identity" class="col-sm-2 control-label">农户一卡通：</label>
                    <div class="col-sm-10">
                        <input   type="text" name="oneCardSolution" class="form-control" id="oneCardSolution"  onblur='onOneCardSolution(this)'  placeholder="农户一卡通" required>
                        <div id="tishiOneCardSolution" style="color: red;"></div>
                    </div>

                </div>
                <div class="form-group">
                    <label for="tel" class="col-sm-2 control-label">联系电话：</label>
                    <div class="col-sm-10">
                        <input   type="tel" name="tel" class="form-control" onblur='onTel(this)' id="tel" placeholder="联系电话" required>
                        <div id="tishiTel" style="color: red;"></div>
                    </div>

                </div>
                <div class="form-group">
                    <label for="village" class="col-sm-2 control-label">村组：</label>
                    <div class="col-sm-10">
                        <input   type="text" name="village" class="form-control" onblur='onVillage(this)' id="village" placeholder="村组" required>
                        <div id="tishiVillage" style="color: red;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="identify_front" class="col-sm-2 control-label">身份证正面（带国徽的一面）：</label><br>
                    <div class="file-container" style="margin-left:10%;display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                        <button class="btn btn-success fileinput-button" type="button">身份证正面上传</button>
                        <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="identify_front" id="identify_front" onchange=" saveFile(this,this.files[0],1)">
                    </div>
                    <span id="filename1" style="vertical-align: middle">未上传文件</span>
                </div>
                <div class="form-group">
                    <label for="identify_back" class="col-sm-2 control-label">身份证反面（个人信息的一面）：</label><br>
                    <div class="file-container" style="margin-left:10%;display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                        <button class="btn btn-success fileinput-button" type="button">身份证反面上传</button>
                        <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="identify_back" id="identify_back" onchange="saveFile(this,this.files[0],2)">
                    </div>
                    <span id="filename2" style="vertical-align: middle">未上传文件</span>
                </div>
                <br />
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="button" id="submit" class="btn btn-info" style="width: 100%;">保存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--底部导航条-->
<footer class="am-menu am-cf">
    <a href="/poverty/usershen">
        <div class="am-menu-column " id="explore" style="width: 33%;">
            <span>项目申请</span>
        </div>
    </a>
    <a href="/poverty/audit">
        <div class="am-menu-column" id="index" style="width: 33%;">
            <span>项目进度</span>
        </div>
    </a>
    <a href="/poverty/user">
        <div class="am-menu-column active " id="my" style="width: 33%;">
            <span>我的资料</span>
        </div>
    </a>
</footer>
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script th:src="@{/js/jquery.min.js}"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script th:src="@{/js/bootstrap.min.js}"></script>
<script th:inline="javascript">
    var front_path = [[${person.idCardFront}]];
    var back_path = [[${person.idCardReverse}]];
    function saveFile(obj,file,num){
        if(num===1){
            $("#filename1").html(file.name);
        }
        if(num===2){
            $("#filename2").html(file.name);
        }

        var data = new FormData();
        data.append('file', obj.files[0]);
        if(front_path != null && obj.id == 'identify_front'&&front_path != ""){
            data.append('frontPath',front_path);
        }
        if(back_path != null && obj.id == 'identify_back'&&back_path != ""){
            data.append('backPath',back_path);
        }
        //判断类型
        var filename = obj.value;
        extStart = filename.lastIndexOf('.');
        ext = obj.value.substring(extStart,filename.length).toUpperCase();
        data.append('type',ext);
        console.log(data)
        $.ajax({
        url: '/poverty/upIdCard',
        type: 'POST',
        data: data,
        cache: false,
        processData: false,
        contentType: false,
        success:function(result){

                alert("上传成功！");
                if(obj.id == 'identify_front'){
                    front_path=result;

                }else {
                    back_path=result;

                }
            },
        error:function(result){
                alert("上传失败！");
            }
        });
    }

    $(function () {
        if([[${person.id}]] != null ){
            $('#name').val([[${person.name}]])
            $('#identity').val([[${person.identity}]])
            $('#tel').val([[${person.telphone}]])
            $('#village').val([[${person.village}]])
            $('#oneCardSolution').val([[${person.oneCardSolution}]])
            if([[${person.idCardFront}]] != null && [[${person.idCardFront}]] != "" ){

                $("#filename1").html("已上传，点击重新上传")
            }
            if([[${person.idCardReverse}]] != null &&[[${person.idCardReverse}]] != ""){
                $("#filename2").html("已上传，点击重新上传")
            }
        }
    })




    $("#submit").click(function(){

        console.log($("#filename2").html())
        if($('#name').val() != null&& $('#name').val() != "" && $('#identity').val()!=null && $('#identity').val()!="" &&$('#tel').val()!=null &&$('#tel').val()!=""  &&$('#oneCardSolution').val()!=null &&$('#oneCardSolution').val()!=""&&$('#village').val()!=null&&$('#village').val()!="" && $("#filename1").html() !="未上传文件" && $("#filename2").html() !="未上传文件"){
            $.post('/poverty/userMsg',
                {
                    'name':$('#name').val(),
                    'identity':$('#identity').val(),
                    'telphone':$('#tel').val(),
                    'createTime':"",
                    'oneCardSolution':$('#oneCardSolution').val(),
                    'village':$('#village').val(),
                    'idCardFront':front_path,
                    'idCardReverse':back_path,
                    'openid':[[${person.openid}]]
                },
                function(result){
                    //alert("数据: \n" + data + "\n状态: " + status);
                    if(result!=null){
                        window.location.href="/poverty/usershen"
                    }

                });
        }else
        {
            alert("请完善资料！")
        }


    });
</script>

</body>
</html>
