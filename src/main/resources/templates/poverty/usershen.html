<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>
    <!-- Bootstrap -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="col-sm-12">
        <h3 style="text-align: center;">申请页面</h3>
        <!--分割线-->
        <div class="decoration"></div>
        <div class="full-width" style="text-align: center;">
            <h4 class="shadow">补充你的基本信息</h4>
            <p class="shadow">在提交申请表之前，请检查你的信息是否完整，不可有错误信息！</p>
        </div>
        <!--分割线-->
        <div class="decoration"></div>
        <!--表单-->
        <div class="form">
            <form class="form-horizontal">
                <div class="form-group" >
                    <label  class="col-sm-2 control-label">项目名称：</label>
                    <select  class="form-control" style="width: 40%; margin-left: 20px;" name="option" id="select">
                        <option value="-1">请选择项目</option>
                        <option th:each="list : ${projectList}" th:value="${list.id}" th:text="${list.projectName }">
                    </select>
                </div>
                <div class="form-group">
                    <label for="outlay" class="col-sm-2 control-label">项目申请经费：</label>
                    <div class="col-sm-10">
                        <input   type="text" name="outlay" class="form-control" id="outlay" placeholder="项目申请经费/元" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="startTime" class="col-sm-2 control-label">开始时间：</label>
                    <div class="col-sm-10">
                        <input   type="date" name="startTime" class="form-control" id="startTime" placeholder="开始时间" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="endTime" class="col-sm-2 control-label">截止时间：</label>
                    <div class="col-sm-10">
                        <input   type="date" name="endTime" class="form-control" id="endTime" placeholder="截止时间" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="identify_other" class="col-sm-2 control-label">其他证明材料：</label><br>
                    <div class="file-container" style="margin-left:25%;display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                        <button class="btn btn-success fileinput-button" type="button">上传</button>
                        <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="identify_other" id="identify_other" onchange="upOtherFile(this,this.files[0])">
                    </div>
                    <span id="otherFilename" style="vertical-align: middle">未上传文件</span>
                </div>

                <div class="form-group">
                    <label for="scenePhotos" class="col-sm-2 control-label">现场相片上传：</label><br>
                    <div class="file-container" style="margin-left:25%;display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                        <button class="btn btn-success fileinput-button" type="button">上传</button>
                        <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="scenePhotos" id="scenePhotos" onchange="upScenePhotos(this,this.files[0])">
                    </div>
                    <span id="scenePhotosFilename" style="vertical-align: middle">未上传文件</span>
                </div>
                <div class="form-group">
                    <label for="downloadFile" class="col-sm-2 control-label">项目申请书下载：</label><br>
                    <div class="file-container" style="margin-left:25%;display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                        <button class="btn btn-info fileinput-button" type="button">下载</button>
                        <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="button" value="项目申请书下载" name="downloadFile" id="downloadFile">
                    </div>

                </div>
                <div class="form-group">
                    <label for="identify_project" class="col-sm-2 control-label">项目申请书上传：</label><br>
                    <div class="file-container" style="margin-left:25%;display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
                        <button class="btn btn-success fileinput-button" type="button">上传</button>
                        <input style="position:absolute;top:0;left:0;font-size:34px; opacity:0" type="file" name="identify_project" id="identify_project" onchange="upFile(this,this.files[0])">
                    </div>
                    <span id="ProjectFilename" style="vertical-align: middle">未上传文件</span>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="button" id="tijiao" class="btn btn-default">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--底部导航条-->
<footer class="am-menu am-cf">
    <a href="/poverty/usershen">
        <div class="am-menu-column active" id="explore" style="width: 33%;">
            <span>项目申请</span>
        </div>
    </a>
    <a href="/poverty/audit">
        <div class="am-menu-column" id="index" style="width: 33%;">
            <span>项目进度</span>
        </div>
    </a>
    <a href="/poverty/user">
        <div class="am-menu-column " id="my" style="width: 33%;">
            <span>我的资料</span>
        </div>
    </a>
</footer>

</div>
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script th:src="@{/js/jquery.min.js}"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script th:src="@{/js/bootstrap.min.js}"></script>
<script  th:inline="javascript">


    var information_id = getQueryString("informationId");
    var project_path = null;
    var other_path = null;
    var other_file_name = null;
    var project_file_name = null;
    var scenePhotos_path = null;
    function upOtherFile(obj,file){
        $("#otherFilename").html(file.name)
        var data = new FormData();
        data.append('file', obj.files[0]);
        if(other_path != null && obj.id == 'identify_other'){
            data.append('projectPath',other_path);
        }
        //判断类型
        var filename = obj.value;

        extStart = filename.lastIndexOf('.');
        otherFileNameStart = filename.lastIndexOf('\\');
        ext = obj.value.substring(extStart,filename.length).toUpperCase();
        other_file_name = obj.value.substring(otherFileNameStart+1,extStart)
        data.append('type',ext);
        $.ajax({
            url: '/poverty/upOther',
            type: 'POST',
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success:function(result){

                alert("上传成功！");
                if(obj.id == 'identify_other'){
                    other_path=result;
                }
            },
            error:function(result){
                alert("上传失败！");
            }
        });
    };
    function upScenePhotos(obj,file){
        $("#scenePhotosFilename").html(file.name)
        var data = new FormData();
        data.append('file', obj.files[0]);
        if(scenePhotos_path != null && obj.id == 'scenePhotos'){
            data.append('projectPath',scenePhotos_path);
        }
        //判断类型
        var filename = obj.value;

        extStart = filename.lastIndexOf('.');
        otherFileNameStart = filename.lastIndexOf('\\');
        ext = obj.value.substring(extStart,filename.length).toUpperCase();
        other_file_name = obj.value.substring(otherFileNameStart+1,extStart)
        data.append('type',ext);
        $.ajax({
            url: '/poverty/upOther',
            type: 'POST',
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success:function(result){

                alert("上传成功！");
                if(obj.id == 'scenePhotos'){
                    alert(result)
                    scenePhotos_path=result;
                }
            },
            error:function(result){
                alert("上传失败！");
            }
        });
    };
    function upFile(obj,file){
        $("#ProjectFilename").html(file.name)
        var data = new FormData();
        data.append('file', obj.files[0]);
        if(project_path != null && obj.id == 'identify_project'){
            data.append('projectPath',project_path);
        }
        //判断类型

        var filename = obj.value;

        extStart = filename.lastIndexOf('.');
        projectFileNameStart = filename.lastIndexOf('\\');
        ext = obj.value.substring(extStart,filename.length).toUpperCase();
        project_file_name = obj.value.substring(projectFileNameStart+1,extStart)
        data.append('type',ext);
        $.ajax({
            url: '/poverty/upProjectBook',
            type: 'POST',
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success:function(result){

                alert("上传成功！");
                if(obj.id == 'identify_project'){
                    project_path=result;
                }
            },
            error:function(result){
                alert("上传失败！");
            }
        });
    };

    $("#downloadFile").click(function(){

        if($("#select").val() == -1){
            alert("请选择项目！")
        }else
        {
            window.location.href="/poverty/downloadProject?id="+$("#select").val()
        }


    });

    $("#tijiao").click(function () {

       var datas =  {
            "id":information_id,
            "projectId":$("#select").val(),
            "outlay":$("#outlay").val(),
            "startTime":$("#startTime").val(),
            "endTime":$("#endTime").val(),
            "scenePhotos":scenePhotos_path,
            "otherProofName":other_file_name,
            "otherProof":other_path,
            "projectApplicationName":project_file_name,
            "projectApplication":project_path,
            "personId":[[${person.id}]],
            "createTime":"",
            "stutas":"1"
        }

        $.post("/poverty/saveInformation",datas
       ,
        function(result) {
            if(result!=null){
                window.location.href="/poverty/audit";
            }

        }

        )



    });

    $(function () {
        if(information_id != null){

            $.post("/poverty/findInformationById",
                {
                    "findId":information_id
                },function (result) {
                    $("#select").val(result.projectId)
                    $("#outlay").val(result.outlay)

                })
        }
    })

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = decodeURI(window.location.search).substr(1).match(reg);
        if (r != null)
            return unescape(r[2]);
        return null;
    }



</script>
</body>
</html>
