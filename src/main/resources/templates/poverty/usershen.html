<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>
    <!-- Bootstrap -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="col-sm-12">
        <h3 style="text-align: center;">申请页面</h3>
        <!--分割线-->
        <div class="decoration"></div>
        <div class="full-width" style="text-align: center;">
            <h4 class="shadow">补充你的基本信息</h4>
            <p class="shadow">在提交申请表之前，请检查你的信息是否完整，不可有错误信息！</p>
        </div>
        <!--分割线-->
        <div class="decoration"></div>
        <!--表单-->
        <div class="form">
            <form class="form-horizontal">
                <div class="form-group" >
                    <label  class="col-sm-2 control-label">项目名称：</label>
                    <select  class="form-control" style="width: 40%; margin-left: 20px;" name="option" id="select">
                        <option>请选择项目</option>
                        <option th:each="list : ${projectList}" th:value="${list.id}" th:text="${list.projectName }">
                    </select>
                </div>
                <div class="form-group">
                    <label for="outlay" class="col-sm-2 control-label">项目申请经费：</label>
                    <div class="col-sm-10">
                        <input  style="width: 70%" type="text" name="outlay" class="form-control" id="outlay" placeholder="项目申请经费/元" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="startTime" class="col-sm-2 control-label">开始时间：</label>
                    <div class="col-sm-10">
                        <input  style="width: 70%" type="date" name="startTime" class="form-control" id="startTime" placeholder="开始时间" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="endTime" class="col-sm-2 control-label">截止时间：</label>
                    <div class="col-sm-10">
                        <input  style="width: 70%" type="date" name="endTime" class="form-control" id="endTime" placeholder="截止时间" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="oneCardSolution" class="col-sm-2 control-label">农户一卡通：</label>
                    <div class="col-sm-10">
                        <input  style="width: 50%" type="text" name="oneCardSolution" class="form-control" id="oneCardSolution" placeholder="农户一卡通" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="identify_other" class="col-sm-2 control-label">其他证明材料：</label>
                    <div class="col-sm-10">
                        <input type="file" name="identify_other" id="identify_other" onchange="upOtherFile(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="downloadFile" class="col-sm-2 control-label">项目申请书下载：</label>
                    <div class="col-sm-10">
                        <input type="button" value="项目申请书下载" name="downloadFile" id="downloadFile">
                    </div>
                </div>
                <div class="form-group">
                    <label for="identify_project" class="col-sm-2 control-label">项目申请书上传：</label>
                    <div class="col-sm-10">
                        <input type="file" name="identify_project" id="identify_project" onchange="upFile(this)">
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="button" id="tijiao" class="btn btn-default">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--底部导航条-->
<footer class="am-menu am-cf">
    <a href="/poverty/usershen">
        <div class="am-menu-column" id="explore" style="width: 33%;">
            <span>项目申请</span>
        </div>
    </a>
    <a href="/poverty/audit">
        <div class="am-menu-column" id="index" style="width: 33%;">
            <span>项目进度</span>
        </div>
    </a>
    <a href="/poverty/user">
        <div class="am-menu-column active" id="my" style="width: 33%;">
            <span>我的资料</span>
        </div>
    </a>
</footer>

</div>
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script th:src="@{/js/jquery.min.js}"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script th:src="@{/js/bootstrap.min.js}"></script>
<script  th:inline="javascript">



    var project_path = null;
    var other_path = null;
    var other_file_name = null;
    var project_file_name = null;
    function upOtherFile(obj){
        var data = new FormData();
        data.append('file', obj.files[0]);
        if(other_path != null && obj.id == 'identify_other'){
            data.append('projectPath',other_path);
        }
        //判断类型
        var filename = obj.value;

        extStart = filename.lastIndexOf('.');
        otherFileNameStart = filename.lastIndexOf('\\');
        ext = obj.value.substring(extStart,filename.length).toUpperCase();
        other_file_name = obj.value.substring(otherFileNameStart,extStart)
        data.append('type',ext);
        $.ajax({
            url: '/poverty/upOther',
            type: 'POST',
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success:function(result){

                alert("上传成功！");
                if(obj.id == 'identify_other'){
                    other_path=result;
                }
            },
            error:function(result){
                alert("上传失败！");
            }
        });
    };
    function upFile(obj){
        var data = new FormData();
        data.append('file', obj.files[0]);
        if(project_path != null && obj.id == 'identify_project'){
            data.append('projectPath',project_path);
        }
        //判断类型

        var filename = obj.value;
        console.log(filename)
        extStart = filename.lastIndexOf('.');
        projectFileNameStart = filename.lastIndexOf('\\');
        ext = obj.value.substring(extStart,filename.length).toUpperCase();
        project_file_name = obj.value.substring(otherFileNameStart,extStart)
        data.append('type',ext);
        $.ajax({
            url: '/poverty/upProjectBook',
            type: 'POST',
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            success:function(result){

                alert("上传成功！");
                if(obj.id == 'identify_project'){
                    project_path=result;
                }
            },
            error:function(result){
                alert("上传失败！");
            }
        });
    };

    $("#downloadFile").click(function(){
        $.post("/poverty/downProjectBook",{
            "id":$("#select").val(),
            "name":""
        }, function(result) {

        })
    });

    $("#tijiao").click(function () {

        $.post("/poverty/findPersonId")

       var datas =  {
            "projectId":$("#select").val(),
            "outlay":$("#outlay").val(),
            "startTime":$("#startTime").val(),
            "endTime":$("#endTime").val(),
            "oneCardSolution":[[${person.oneCardSolution}]],
            "otherProofName":other_file_name,
            "otherProof":other_path,
            "projectApplicationName":project_file_name,
            "projectApplication":project_path,
            "personId":[[${person.id}]],
            "createTime":"",
            "stutas":"1"
        }
        console.log(datas)
        $.post("/poverty/saveInformation",datas
       ,
        function(result) {
            window.location.href="http://localhost:8083/"+result;
        }

        )



    });





</script>
</body>
</html>
